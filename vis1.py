from glob import glob
import sys,os

import torch
from train import init_conf
def main():
    conf = init_conf(CUDA=0)

    epoch = sys.argv[sys.argv.index('--LOAD')+1]
    epoch = int(epoch)
    res = glob(os.path.join("Checkpoints",f"{conf.model.__class__.__name__}_{epoch}_*.pkl"))

    fn = res[0]
    xx = torch.load(fn)
    conf.model.load_state_dict(xx['model'])
    print(xx['test_losses'][-1])

    from tqdm import tqdm
    model = conf.model



    self = model
    print((model._template.softmax(3)[0,1]*100).long())
    print((model._template.softmax(3)[0,0]*100).long())


    dbg = 0
    xx = torch.cat([item['english'] for item in tqdm(conf.dataloader)],dim=0)
    clup = torch.cat([model.log_prob_cluster(item['english'],dbg) for item in tqdm(conf.dataloader)],dim=0)
    # clup = torch.cat([model.log_prob(item['english']) for item in tqdm(conf.dataloader)],dim=0)
    # clup = torch.cat(clup,dim=0)[:,:,0]
    x = clup.exp()
    print(f'Average Label:{x.mean(0)}')
    print(f'Max Label:{x.max(0)[0]}')
    print(clup.max(0)[0])
    # print(x.max(0)[0])
    clu = clup.argmax(dim=1)
    # clu[:,0]
    # xxx = xx[sel][0]
    idx = -4



    idx = 0
    cutoff = -2.5
    print(x.mean(0))
    print(x.max(0)[0])
    print(x.max(0)[0][idx])
    # sel = (x[:,idx]>0.5)
    # sel = (x[:,idx]>0.14)
    sel = (clup[:,idx]>cutoff)
    print(sel.sum())
    def mapper(xi,conf=conf):return conf.dataset.english_vocab_reversed[xi]
    for xxx in xx[sel][:10]: print(':'.join(map(mapper,xxx)))


    for xxx in xx[sel][:20]:
        res = [];
        for xi in xxx:  res.append(conf.dataset.english_vocab_reversed[xi])


    # def log_prob_cluster(self,x):
    if 1:
        item = next(iter(conf.dataloader))
        # self = model
        # x = item['english']
        # z = self.log_prob_chain(x)
        # z = z * x.shape[1]
        # logp = z.logsumexp(dim=2).log_softmax(dim=1)[:,:,0]
        # return logp

    import pdb; pdb.set_trace()
    print(fn)
main()
'''
epoch 5
tensor([[ 7, 11,  6,  7, 13,  8,  5, 12, 13, 12],
        [18, 10, 12, 11,  4,  4,  6,  4, 15, 10],
        [11, 12,  5, 16,  5,  7, 10,  9,  8, 13],
        [ 7, 16,  7, 10,  8,  5, 11,  5, 12, 14],
        [ 7,  9, 10, 17,  5, 11,  7,  7, 11, 12],
        [21,  8,  8, 11,  5, 12,  3,  6, 11, 10],
        [16, 12,  5, 17,  7, 10,  3, 12,  6,  6],
        [12,  6, 16, 17,  6,  5,  3, 11, 11,  7],
        [ 8,  5,  4,  6, 14, 14, 17,  8,  6, 14],
        [18,  6,  7, 11, 10, 10,  3, 10, 15,  5],
        [12,  5,  8, 13, 11, 14, 13,  9,  8,  3],
        [11,  8,  9, 20,  7,  5,  6,  8, 12,  9],
        [18,  4,  6,  3, 16,  4,  9,  5, 18, 12],
        [ 5, 16,  3,  9,  6,  7, 11, 14, 10, 14],
        [20,  7,  5,  7,  8, 18, 10,  4,  8,  8]])


#### A strong mixing tendency is captured here

#### The model preferes to generate a boring
position-irrelevant template and unable to capture
the syntactical structure

# epoch 70
tensor([[ 1, 22,  1,  1,  4, 16,  1, 25,  2, 24],
        [ 5, 28,  2,  2,  1, 11,  1, 12,  3, 28],
        [ 2, 25,  0,  2,  1, 16,  1, 19,  1, 27],
        [ 1, 35,  1,  2,  1, 11,  2, 12,  2, 29],
        [ 1, 21,  1,  3,  1, 24,  1, 16,  2, 26],
        [ 5, 18,  1,  2,  1, 27,  0, 14,  2, 24],
        [ 2, 26,  0,  3,  2, 22,  0, 27,  1, 12],
        [ 3, 18,  3,  4,  1, 13,  0, 31,  2, 19],
        [ 1, 10,  0,  1,  2, 30,  3, 17,  1, 30],
        [ 5, 16,  1,  2,  2, 27,  0, 26,  3, 12],
        [ 2, 12,  1,  2, 10, 34,  2, 21,  1,  8],
        [ 2, 20,  2,  4,  3, 13,  1, 23,  2, 24],
        [ 3,  8,  1,  0, 32,  9,  1, 11,  4, 25],
        [ 0, 27,  0,  1,  4, 12,  1, 25,  1, 24],
        [ 3, 13,  0,  1, 14, 34,  1,  9,  4, 16]])


# epoch 102
tensor([[ 3,  1, 11,  2, 36, 16,  3,  2, 17,  3],
        [13,  1, 13, 15,  1, 23,  4,  2, 22,  1],
        [ 6,  5, 10,  2, 17, 13,  3, 24, 14,  1],
        [37,  3,  9, 21,  1,  2, 17,  1,  3,  2],
        [23,  1,  7,  1, 28, 12, 10,  4,  9,  1],
        [ 1, 25, 30,  4,  3, 12,  1,  3, 15,  2],
        [ 9,  4,  7,  3, 18, 10,  9, 16, 16,  4],
        [ 9,  2,  2, 16,  5, 31, 18,  2,  8,  2],
        [ 1,  7,  2,  2, 14, 16,  2, 14, 34,  3],
        [22,  2,  4, 12,  1, 19, 20,  6,  8,  1],
        [ 9,  1, 10,  1, 30,  4,  7, 16, 14,  3],
        [30,  1, 33,  7,  1,  5, 12,  2,  1,  4],
        [ 2,  1, 20,  2,  8, 23,  2, 13, 23,  2],
        [13,  2, 27, 11,  2,  6, 26,  3,  3,  1],
        [ 1,  2,  7,  4, 19, 17,  1, 27, 14,  4]])
# e132
tensor([[ 2,  1, 12,  2, 38, 16,  2,  2, 18,  2],
        [13,  1, 13, 14,  1, 23,  4,  2, 23,  1],
        [ 5,  4, 11,  2, 18, 14,  3, 23, 15,  1],
        [38,  2,  9, 21,  1,  1, 18,  1,  2,  1],
        [23,  1,  7,  1, 29, 12, 10,  3,  9,  1],
        [ 1, 24, 31,  3,  2, 12,  1,  2, 16,  2],
        [ 7,  4,  8,  3, 19, 10,  8, 16, 17,  4],
        [10,  1,  2, 16,  4, 32, 18,  1,  9,  1],
        [ 1,  6,  2,  2, 15, 16,  2, 14, 36,  2],
        [23,  2,  4, 12,  1, 20, 21,  5,  7,  1],
        [ 7,  1, 12,  1, 33,  3,  7, 14, 15,  2],
        [31,  0, 35,  7,  1,  4, 12,  1,  1,  3],
        [ 1,  1, 21,  2,  8, 22,  1, 13, 23,  2],
        [13,  1, 28, 11,  2,  7, 27,  2,  2,  1],
        [ 1,  1,  7,  3, 20, 16,  1, 27, 15,  3]])

# e140
tensor([[ 2,  1, 13,  1, 38, 16,  2,  2, 18,  2],
        [13,  1, 13, 14,  1, 24,  4,  2, 23,  1],
        [ 5,  4, 11,  2, 19, 14,  3, 23, 15,  1],
        [39,  2,  9, 21,  1,  1, 18,  1,  2,  1],
        [23,  1,  7,  1, 29, 11, 11,  3,  9,  1],
        [ 1, 24, 32,  3,  2, 12,  1,  2, 17,  2],
        [ 7,  4,  9,  2, 20,  9,  8, 15, 18,  3],
        [10,  1,  2, 16,  4, 33, 19,  1,  9,  1],
        [ 1,  5,  2,  2, 15, 16,  2, 14, 36,  2],
        [23,  2,  4, 12,  1, 20, 22,  4,  7,  1],
        [ 7,  1, 12,  1, 34,  3,  7, 14, 15,  2],
        [31,  0, 35,  7,  1,  4, 13,  1,  0,  3],
        [ 1,  1, 22,  2,  8, 22,  1, 13, 24,  2],
        [14,  1, 28, 11,  2,  7, 27,  2,  2,  1],
        [ 0,  1,  7,  3, 21, 16,  1, 28, 15,  3]])

tensor([[ 2,  1, 13,  1, 38, 16,  2,  2, 18,  2],
        [13,  1, 13, 14,  1, 24,  4,  2, 23,  1],
        [ 5,  4, 11,  2, 19, 14,  3, 23, 15,  1],
        [39,  2,  9, 21,  1,  1, 18,  1,  2,  1],
        [23,  1,  7,  1, 29, 11, 11,  3,  9,  1],
        [ 1, 24, 32,  3,  2, 12,  1,  2, 17,  2],
        [ 7,  4,  9,  2, 20,  9,  8, 15, 18,  3],
        [10,  1,  2, 16,  4, 33, 19,  1,  9,  1],
        [ 1,  5,  2,  2, 15, 16,  2, 14, 36,  2],
        [23,  2,  4, 12,  1, 20, 22,  4,  7,  1],
        [ 7,  1, 12,  1, 34,  3,  7, 14, 15,  2],
        [31,  0, 35,  7,  1,  4, 13,  1,  0,  3],
        [ 1,  1, 22,  2,  8, 22,  1, 13, 24,  2],
        [14,  1, 28, 11,  2,  7, 27,  2,  2,  1],
        [ 0,  1,  7,  3, 21, 16,  1, 28, 15,  3]])

SoftmaxMixture
epc0
tensor([[ 6, 10,  8,  7, 12,  9,  6, 13, 13, 11],
        [15,  9, 12, 10,  4,  5,  7,  5, 18, 10],
        [10, 11,  5, 15,  6,  7, 12,  9,  9, 12],
        [ 6, 14,  6,  9,  9,  6, 13,  6, 15, 12],
        [ 6,  8, 12, 16,  6, 10,  7,  6, 13, 10],
        [18,  7,  8, 10,  6, 14,  4,  6, 14,  9],
        [15, 11,  6, 18,  9,  9,  4, 12,  7,  4],
        [11,  6, 16, 15,  7,  5,  4, 12, 13,  6],
        [ 7,  4,  5,  5, 13, 14, 21,  8,  5, 13],
        [15,  5,  8,  9, 12, 11,  4, 10, 18,  4],
        [12,  3,  9, 12, 12, 13, 13,  8,  8,  3],
        [10,  6, 11, 17,  9,  5,  7,  9, 13,  9],
        [17,  3,  7,  3, 14,  4, 12,  5, 17, 12],
        [ 4, 13,  4,  8,  7,  7, 14, 15,  8, 14],
        [20,  5,  7,  7,  7, 17, 13,  4,  7,  8]])

epc20
tensor([[ 3, 16,  3,  4, 11, 12,  3, 19,  6, 18],
        [16, 18,  7,  7,  2,  7,  4,  8,  9, 18],
        [ 6, 19,  2,  8,  3, 12,  5, 14,  4, 20],
        [ 5, 26,  3,  6,  4,  8,  6,  9,  7, 21],
        [ 4, 15,  6,  9,  3, 18,  4, 11,  6, 19],
        [16, 13,  4,  7,  3, 18,  2,  9,  6, 16],
        [ 9, 20,  3,  9,  5, 16,  2, 20,  3,  9],
        [10, 11, 10, 11,  4,  8,  2, 20,  7, 12],
        [ 4,  7,  2,  3,  8, 23, 10, 13,  3, 23],
        [14, 11,  4,  7,  6, 17,  2, 17,  9,  8],
        [ 7,  8,  5,  8,  8, 25,  8, 15,  5,  6],
        [ 7, 13,  6, 13,  5,  8,  4, 15,  8, 16],
        [10,  6,  3,  2, 21,  7,  5,  8, 15, 19],
        [ 2, 22,  1,  4,  3, 10,  6, 21,  5, 20],
        [10, 10,  3,  3, 11, 26,  5,  7,  8, 12]])

epc80
tensor([[ 4,  2, 10,  2, 34, 16,  3,  3, 16,  3],
        [13,  1, 12, 15,  1, 22,  5,  3, 21,  1],
        [ 8,  6, 10,  2, 16, 12,  4, 23, 13,  1],
        [36,  4,  8, 20,  2,  2, 17,  1,  3,  2],
        [22,  2,  6,  2, 27, 12, 10,  5,  8,  1],
        [ 1, 25, 28,  5,  3, 11,  1,  3, 14,  3],
        [10,  5,  6,  3, 16, 10, 10, 16, 15,  4],
        [ 9,  2,  2, 16,  6, 31, 17,  2,  8,  2],
        [ 2,  8,  2,  2, 13, 15,  2, 14, 33,  3],
        [21,  3,  3, 11,  1, 18, 20,  7, 10,  2],
        [ 9,  1,  9,  1, 28,  5,  8, 18, 13,  3],
        [29,  1, 32,  7,  1,  6, 12,  2,  1,  4],
        [ 2,  1, 19,  3,  8, 23,  2, 13, 22,  2],
        [13,  2, 26, 11,  3,  7, 25,  4,  4,  2],
        [ 1,  2,  6,  5, 19, 17,  1, 26, 13,  5]])

tensor([[ 2,  1, 13,  1, 38, 16,  2,  2, 18,  2],
        [13,  1, 13, 14,  1, 24,  4,  2, 23,  1],
        [ 5,  4, 11,  2, 19, 14,  3, 23, 15,  1],
        [39,  2,  9, 21,  1,  1, 18,  1,  2,  1],
        [23,  1,  7,  1, 29, 11, 11,  3,  9,  1],
        [ 1, 24, 32,  3,  2, 12,  1,  2, 17,  2],
        [ 7,  4,  9,  2, 20,  9,  8, 15, 18,  3],
        [10,  1,  2, 16,  4, 33, 19,  1,  9,  1],
        [ 1,  5,  2,  2, 15, 16,  2, 14, 36,  2],
        [23,  2,  4, 12,  1, 20, 22,  4,  7,  1],
        [ 7,  1, 12,  1, 34,  3,  7, 14, 15,  2],
        [31,  0, 35,  7,  1,  4, 13,  1,  0,  3],
        [ 1,  1, 22,  2,  8, 22,  1, 13, 24,  2],
        [14,  1, 28, 11,  2,  7, 27,  2,  2,  1],
        [ 0,  1,  7,  3, 21, 16,  1, 28, 15,  3]])
'''
